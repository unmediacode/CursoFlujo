<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dosificaci√≥n Mensual</title>
    <meta name="description" content="Agenda de dosificaci√≥n y control diario para farmacia." />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <h1 class="logo">Dosificaci√≥n Mensual</h1>
        <nav class="nav">
          <a href="#inicio">Calendario</a>
          <a href="#ayuda">Ayuda</a>
        </nav>
      </div>
    </header>

    <main id="inicio">
      <section class="container">
        <div class="calendar" aria-label="Calendario mensual">
          <div class="calendar__header">
            <div class="left-actions">
              <button class="cal-btn" id="prevBtn" aria-label="Anterior">‚Äπ</button>
            </div>
            <h2 class="calendar__title" id="calTitle" aria-live="polite"></h2>
            <div class="right-actions">
              <button class="cal-btn" id="searchBtn" aria-label="Buscar clientes">üîé</button>
              <button class="cal-btn" id="nextBtn" aria-label="Siguiente">‚Ä∫</button>
            </div>
          </div>
          <div class="view-toggle" role="tablist" aria-label="Selector de vista">
            <button id="viewMonth" class="view-toggle__btn is-active" role="tab" aria-selected="true">Mensual</button>
            <button id="viewWeek" class="view-toggle__btn" role="tab" aria-selected="false">Semanal</button>
            <button id="viewMonthFull" class="view-toggle__btn" role="tab" aria-selected="false">Mensual completa</button>
          </div>

          <div class="calendar__weekdays" aria-hidden="true">
            <span>Lu</span>
            <span>Ma</span>
            <span>Mi</span>
            <span>Ju</span>
            <span>Vi</span>
            <span>Sa</span>
            <span>Do</span>
          </div>

          <div class="calendar__grid" id="calGrid" role="grid" aria-readonly="true" aria-label="D√≠as del mes"></div>
        </div>
      </section>
      
      <!-- Modal para a√±adir cliente -->
      <div class="modal" id="clientModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal__overlay" data-close-modal></div>
        <div class="modal__content" role="document">
          <h3 id="modalTitle">A√±adir cliente</h3>
          <form id="clientForm">
            <div class="form-row">
              <label>D√≠as seleccionados</label>
              <input type="hidden" id="clientDate" />
              <input type="text" id="clientDateSummary" readonly value="Sin d√≠as seleccionados" />
            </div>
            <div class="mini-cal" id="miniCal" aria-label="Seleccionar d√≠as para el cliente">
              <div class="mini-cal__header">
                <button type="button" class="mini-cal__nav" id="miniCalPrev" aria-label="Mes anterior">‚Äπ</button>
                <span class="mini-cal__title" id="miniCalTitle"></span>
                <button type="button" class="mini-cal__nav" id="miniCalNext" aria-label="Mes siguiente">‚Ä∫</button>
              </div>
              <div class="mini-cal__weekdays">
                <span>Lu</span>
                <span>Ma</span>
                <span>Mi</span>
                <span>Ju</span>
                <span>Vi</span>
                <span>Sa</span>
                <span>Do</span>
              </div>
              <div class="mini-cal__grid" id="miniCalGrid"></div>
              <p class="mini-cal__hint">Puedes seleccionar varios d√≠as laborables. Los fines de semana est√°n deshabilitados.</p>
            </div>
            <div class="form-row">
              <label>Nombre del cliente</label>
              <input type="text" id="clientName" placeholder="Ej. Juan P√©rez" required />
            </div>
            <div class="form-row">
              <label>Tel√©fono</label>
              <input type="tel" id="clientPhone" placeholder="Ej. 600 123 123" />
            </div>
            <div class="form-row">
              <label>Notas</label>
              <textarea id="clientNotes" rows="2" placeholder="Observaciones (opcional)"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">A√±adir cliente</button>
              <button type="button" class="btn btn--secondary" data-close-modal>Cancelar</button>
            </div>
            <p class="form-error" id="clientError" hidden></p>
            <div class="client-meta">
              <small id="clientRemaining"></small>
            </div>
            <ul id="clientList" class="client-list" aria-live="polite"></ul>
          </form>
        </div>
      </div>

      <!-- Modal de detalle de cliente -->
      <div class="modal" id="clientDetailModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
        <div class="modal__overlay" data-close-detail></div>
        <div class="modal__content client-detail" role="document">
          <h3 id="detailTitle">Detalle del cliente</h3>
          <form id="detailForm">
            <div class="form-row">
              <label for="detailNameInput">Nombre</label>
              <input type="text" id="detailNameInput" required />
            </div>
            <div class="form-row">
              <label for="detailPhoneInput">Tel√©fono</label>
              <input type="tel" id="detailPhoneInput" />
            </div>
            <div class="form-row">
              <label for="detailNotesInput">Notas</label>
              <textarea id="detailNotesInput" rows="2"></textarea>
            </div>
            <p class="form-error" id="detailError" hidden></p>
            <div class="form-actions client-detail__actions">
              <button type="submit" class="btn">Guardar cambios</button>
              <button type="button" class="btn btn--secondary" data-reset-detail>Restablecer</button>
              <button type="button" class="btn btn--danger" data-delete-detail>Eliminar cliente</button>
              <button type="button" class="btn btn--secondary" data-close-detail>Cerrar</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal de b√∫squeda -->
      <div class="modal" id="searchModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
        <div class="modal__overlay" data-close-search></div>
        <div class="modal__content" role="document">
          <h3 id="searchTitle">Buscar clientes por nombre</h3>
          <form id="searchForm">
            <div class="form-row">
              <label>Nombre contiene</label>
              <input type="text" id="searchInput" placeholder="Ej. Juan" required />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Buscar</button>
              <button type="button" class="btn btn--secondary" data-close-search>Cancelar</button>
            </div>
            <p class="form-error" id="searchError" hidden></p>
          </form>
          <ul id="searchResults" class="client-list" aria-live="polite"></ul>
        </div>
      </div>

      <section id="ayuda" class="container help">
        <h2>Gu√≠a r√°pida para el equipo de la farmacia</h2>
        <div class="help-grid" role="list">
          <article class="help-card" role="listitem">
            <h3>Registrar un paciente</h3>
            <p>Elige el d√≠a en el calendario mensual, revisa las plazas disponibles y usa el mini calendario del formulario para marcar todos los d√≠as laborables necesarios. Completa nombre, tel√©fono y notas (tratamiento, recordatorios, alergias...).</p>
          </article>
          <article class="help-card" role="listitem">
            <h3>Controlar la semana</h3>
            <p>Cambia a la vista semanal para ver solo los pacientes activos de lunes a viernes. Haz clic sobre el nombre para revisar o confirmar los detalles guardados.</p>
          </article>
          <article class="help-card" role="listitem">
            <h3>Editar o anular</h3>
            <p>Utiliza el bot√≥n <strong>Editar</strong> dentro del d√≠a para actualizar datos. Si el paciente cancela la recogida, pulsa <strong>Eliminar</strong> y libera la plaza.</p>
          </article>
          <article class="help-card" role="listitem">
            <h3>Buscar r√°pidamente</h3>
            <p>Desde el icono de lupa puedes localizar cualquier paciente por nombre y saltar directamente a su fecha de dosificaci√≥n.</p>
          </article>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <small>¬© 2025 ‚Äî Creada por, Miguel Taboada </small>
      </div>
    </footer>

    <script>
      // L√≥gica del calendario mensual con paginaci√≥n (prev/next)
      (function() {
        const monthNames = [
          'Enero','Febrero','Marzo','Abril','Mayo','Junio',
          'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
        ];

        const state = (function initState() {
          const now = new Date();
          return { year: now.getFullYear(), month: now.getMonth() };
        })();

        const titleEl = document.getElementById('calTitle');
        const calendarContainer = document.querySelector('.calendar');
        const gridEl = document.getElementById('calGrid');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const viewMonthBtn = document.getElementById('viewMonth');
        const viewWeekBtn = document.getElementById('viewWeek');
        const viewMonthFullBtn = document.getElementById('viewMonthFull');
        const searchBtn = document.getElementById('searchBtn');
        const clientDateInput = document.getElementById('clientDate');
        const clientDateSummaryInput = document.getElementById('clientDateSummary');
        const miniCalTitleEl = document.getElementById('miniCalTitle');
        const miniCalGridEl = document.getElementById('miniCalGrid');
        const miniCalPrevBtn = document.getElementById('miniCalPrev');
        const miniCalNextBtn = document.getElementById('miniCalNext');
        const detailModal = document.getElementById('clientDetailModal');
        const detailForm = document.getElementById('detailForm');
        const detailNameInput = document.getElementById('detailNameInput');
        const detailPhoneInput = document.getElementById('detailPhoneInput');
        const detailNotesInput = document.getElementById('detailNotesInput');
        const detailErrorEl = document.getElementById('detailError');
        const detailResetBtn = document.querySelector('[data-reset-detail]');
        const detailDeleteBtn = document.querySelector('[data-delete-detail]');

        const API_BASE = 'http://localhost:3000';

        function escapeHtml(str) {
          return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
        }

        function buildClientTags(client) {
          if (!client) return '';
          const name = typeof client.name === 'string' ? client.name.trim() : '';
          if (!name) return '';
          return `<span class="calendar__tag calendar__tag--name" data-client-detail role="button" tabindex="0" aria-label="Ver detalle de ${escapeHtml(name)}">${escapeHtml(name)}</span>`;
        }

        function buildCalendarEntry(client, dayISO) {
          if (!client) return '';
          const name = typeof client.name === 'string' ? client.name.trim() : '';
          const phone = typeof client.phone === 'string' ? client.phone.trim() : '';
          const notes = typeof client.notes === 'string' ? client.notes.trim() : '';
          const attrParts = [];
          if (client.id != null) attrParts.push(`data-client-id="${escapeHtml(String(client.id))}"`);
          if (dayISO) attrParts.push(`data-client-day="${escapeHtml(dayISO)}"`);
          attrParts.push(`data-client-name="${escapeHtml(name)}"`);
          attrParts.push(`data-client-phone="${escapeHtml(phone)}"`);
          attrParts.push(`data-client-notes="${escapeHtml(notes)}"`);
          const attrs = attrParts.join(' ');
          const content = buildClientTags(client);
          return content ? `<li class="calendar__entry" ${attrs}>${content}</li>` : '';
        }

        function formatISOToLabel(iso) {
          if (!iso) return '';
          const d = new Date(iso + 'T00:00:00Z');
          if (Number.isNaN(d.getTime())) return iso;
          return `${String(d.getUTCDate()).padStart(2, '0')}/${String(d.getUTCMonth() + 1).padStart(2, '0')}/${d.getUTCFullYear()}`;
        }

        function updateSelectedDaysSummary() {
          if (!clientDateSummaryInput) return;
          const values = Array.from(modalSelectedDays).sort();
          if (values.length === 0) {
            clientDateSummaryInput.value = 'Sin d√≠as seleccionados';
          } else if (values.length <= 3) {
            clientDateSummaryInput.value = values.map(formatISOToLabel).join(', ');
          } else {
            clientDateSummaryInput.value = `${values.length} d√≠as seleccionados`;
          }
          if (clientDateInput) clientDateInput.value = modalDayISO || '';
        }

        function shiftMiniCalMonth(delta) {
          if (modalCalYear == null || modalCalMonth == null) return;
          const ref = new Date(Date.UTC(modalCalYear, modalCalMonth + delta, 1));
          modalCalYear = ref.getUTCFullYear();
          modalCalMonth = ref.getUTCMonth();
          renderMiniCalendar();
        }

        function toggleMiniCalDay(iso) {
          if (!iso) return;
          if (modalSelectedDays.has(iso)) modalSelectedDays.delete(iso);
          else modalSelectedDays.add(iso);
          updateSelectedDaysSummary();
          renderMiniCalendar();
        }

        function renderMiniCalendar() {
          if (!miniCalGridEl || modalCalYear == null || modalCalMonth == null) return;
          const title = `${monthNames[modalCalMonth]} ${modalCalYear}`;
          if (miniCalTitleEl) miniCalTitleEl.textContent = title;

          const firstDay = new Date(Date.UTC(modalCalYear, modalCalMonth, 1));
          const startWeekday = (firstDay.getUTCDay() + 6) % 7;
          const daysInMonth = new Date(Date.UTC(modalCalYear, modalCalMonth + 1, 0)).getUTCDate();
          const daysInPrevMonth = new Date(Date.UTC(modalCalYear, modalCalMonth, 0)).getUTCDate();
          const totalCells = 42;
          const cells = [];

          for (let i = startWeekday - 1; i >= 0; i--) {
            cells.push({ day: daysInPrevMonth - i, offset: -1, other: true });
          }
          for (let d = 1; d <= daysInMonth; d++) {
            cells.push({ day: d, offset: 0, other: false });
          }
          while (cells.length < totalCells) {
            const value = cells.length - (startWeekday + daysInMonth) + 1;
            cells.push({ day: value, offset: 1, other: true });
          }

          const html = cells.map((cell) => {
            const ref = new Date(Date.UTC(modalCalYear, modalCalMonth + cell.offset, cell.day));
            const iso = `${ref.getUTCFullYear()}-${String(ref.getUTCMonth() + 1).padStart(2, '0')}-${String(ref.getUTCDate()).padStart(2, '0')}`;
            const weekday = ref.getUTCDay();
            const isWeekend = weekday === 0 || weekday === 6;
            const isDisabled = isWeekend;
            const isSelected = modalSelectedDays.has(iso);
            const classes = ['mini-cal__day'];
            if (cell.other) classes.push('is-other');
            if (isDisabled) classes.push('is-disabled');
            if (isSelected) classes.push('is-selected');
            const disabledAttr = isDisabled ? 'disabled' : '';
            const ariaPressed = `aria-pressed="${isSelected ? 'true' : 'false'}"`;
            return `<button type="button" class="${classes.join(' ')}" data-iso="${iso}" ${ariaPressed} ${disabledAttr}>${cell.day}</button>`;
          }).join('');

          miniCalGridEl.innerHTML = html;
          miniCalGridEl.querySelectorAll('.mini-cal__day:not(.is-disabled)').forEach((btn) => {
            btn.addEventListener('click', () => {
              const iso = btn.getAttribute('data-iso');
              toggleMiniCalDay(iso);
            });
          });
        }

        function setDetailFormValues(values) {
          if (detailNameInput) detailNameInput.value = values.name || '';
          if (detailPhoneInput) detailPhoneInput.value = values.phone || '';
          if (detailNotesInput) detailNotesInput.value = values.notes || '';
        }

        function clearDetailMessage() {
          if (!detailErrorEl) return;
          detailErrorEl.hidden = true;
          detailErrorEl.textContent = '';
          detailErrorEl.classList.remove('is-success');
        }

        function showDetailMessage(text, success = false) {
          if (!detailErrorEl) return;
          detailErrorEl.textContent = text;
          detailErrorEl.hidden = false;
          detailErrorEl.classList.toggle('is-success', success);
          if (!success) detailErrorEl.classList.remove('is-success');
        }

        function syncBodyScrollLock() {
          const anyOpen = Array.from(document.querySelectorAll('.modal')).some(modal => modal.getAttribute('aria-hidden') === 'false');
          document.body.style.overflow = anyOpen ? 'hidden' : '';
        }

        function openClientDetail({ id, day, name, phone, notes }) {
          let normalizedId = null;
          if (id !== undefined && id !== null && String(id).trim() !== '') {
            const parsed = Number(id);
            normalizedId = Number.isFinite(parsed) ? parsed : null;
          }
          detailContext = {
            id: normalizedId,
            day: day || modalDayISO || null,
            name: (name || '').trim(),
            phone: (phone || '').trim(),
            notes: (notes || '').trim()
          };
          setDetailFormValues(detailContext);
          clearDetailMessage();
          detailModal.setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
          if (detailNameInput) detailNameInput.focus();
        }

        function closeClientDetail() {
          detailModal.setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
          detailContext = { id: null, day: null, name: '', phone: '', notes: '' };
          if (detailForm) detailForm.reset();
          clearDetailMessage();
        }

        function attachClientDetailHandlers(root = document) {
          if (!root) return;
          root.querySelectorAll('[data-client-detail]').forEach(el => {
            if (el.dataset.clientDetailBound === '1') return;
            el.dataset.clientDetailBound = '1';
            const getDetailData = () => {
              const container = el.closest('[data-client-id]') || el.closest('.calendar__entry') || el.closest('.client-info') || el.closest('[data-client-name]');
              const attrFrom = (attr) => {
                if (container && container.hasAttribute(attr)) {
                  const v = container.getAttribute(attr);
                  if (v && v.trim()) return v.trim();
                }
                const fallback = el.closest(`[${attr}]`);
                if (fallback && fallback.hasAttribute(attr)) {
                  const v = fallback.getAttribute(attr);
                  if (v && v.trim()) return v.trim();
                }
                return '';
              };
              const nameFromText = container ? container.textContent.trim() : '';
              return {
                id: attrFrom('data-client-id'),
                day: attrFrom('data-client-day') || attrFrom('data-iso') || '',
                name: attrFrom('data-client-name') || nameFromText,
                phone: attrFrom('data-client-phone'),
                notes: attrFrom('data-client-notes')
              };
            };

            el.addEventListener('click', (ev) => {
              ev.stopPropagation();
              openClientDetail(getDetailData());
            });
            el.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter' || ev.key === ' ') {
                ev.preventDefault();
                openClientDetail(getDetailData());
              }
            });
          });
        }

        // UI helpers: edici√≥n inline
        function enterEdit(li, dayISO) {
          const id = li.getAttribute('data-id');
          const nameEl = li.querySelector('[data-text]');
          const actions = li.querySelector('[data-actions]');
          const current = nameEl.textContent.trim();
          li.classList.add('is-editing');
          nameEl.innerHTML = `<input type="text" class="inline-input" value="${escapeHtml(current)}" />`;
          actions.innerHTML = `
            <button type="button" class="link primary" data-save>Guardar</button>
            <button type="button" class="link" data-cancel>Cancelar</button>
          `;
          actions.querySelector('[data-save]').addEventListener('click', async () => {
            const val = li.querySelector('.inline-input').value.trim();
            if (!val || val === current) { exitEdit(li, current); return; }
            await updateClientName(id, val, dayISO);
          });
          actions.querySelector('[data-cancel]').addEventListener('click', () => exitEdit(li, current));
        }

        function exitEdit(li, text) {
          const nameEl = li.querySelector('[data-text]');
          const actions = li.querySelector('[data-actions]');
          nameEl.textContent = text;
          actions.innerHTML = `
            <button type="button" class="link primary" data-edit="${li.getAttribute('data-id')}">Editar</button>
            <button type="button" class="link danger" data-del="${li.getAttribute('data-id')}">Eliminar</button>
          `;
          li.classList.remove('is-editing');
          // Reenganchar eventos
          actions.querySelector('[data-edit]').addEventListener('click', () => enterEdit(li, modalDayISO));
          actions.querySelector('[data-del]').addEventListener('click', () => enterDeleteConfirm(li, modalDayISO));
        }

        // UI helpers: confirmaci√≥n de borrado inline
        function enterDeleteConfirm(li, dayISO) {
          const id = li.getAttribute('data-id');
          const actions = li.querySelector('[data-actions]');
          const prev = actions.innerHTML;
          actions.setAttribute('data-prev', prev);
          actions.innerHTML = `
            <span class="confirm-text">¬øEliminar?</span>
            <button type="button" class="link danger" data-confirm>Confirmar</button>
            <button type="button" class="link" data-cancel>Cancelar</button>
          `;
          actions.querySelector('[data-confirm]').addEventListener('click', async () => {
            await deleteClient(id, dayISO);
          });
          actions.querySelector('[data-cancel]').addEventListener('click', () => {
            actions.innerHTML = actions.getAttribute('data-prev');
            actions.removeAttribute('data-prev');
            // Reenganchar eventos
            actions.querySelector('[data-edit]').addEventListener('click', () => enterEdit(li, dayISO));
            actions.querySelector('[data-del]').addEventListener('click', () => enterDeleteConfirm(li, dayISO));
          });
        }

        async function fetchSummary(year, month /* 0-11 */) {
          const y = year;
          const m = month + 1; // API espera 1..12
          try {
            const res = await fetch(`${API_BASE}/api/clients/summary?year=${y}&month=${m}`);
            const data = await res.json();
            if (!data.ok) return {};
            // Mapa YYYY-MM-DD -> { count, clients: [] }
            const map = {};
            for (const r of data.rows || []) {
              let clients = [];
              if (Array.isArray(r.clients)) {
                clients = r.clients;
              } else if (typeof r.clients === 'string') {
                try {
                  clients = JSON.parse(r.clients) || [];
                } catch (_) {
                  clients = [];
                }
              }
              map[r.day] = {
                count: Number(r.count ?? clients.length ?? 0),
                clients
              };
            }
            return map;
          } catch (e) {
            console.error('summary error', e);
            return {};
          }
        }

        async function addClient({ dayISO, name, phone, notes }, { skipRefresh = false, refreshDay = dayISO } = {}) {
          const errEl = document.getElementById('clientError');
          errEl.hidden = true; errEl.textContent = '';
          try {
            const res = await fetch(`${API_BASE}/api/clients`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ day: dayISO, name, phone, notes })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              errEl.textContent = data.error || 'Error al a√±adir cliente';
              errEl.hidden = false;
              return false;
            }
            if (!skipRefresh) {
              await render();
              await loadClientsInModal(refreshDay);
            }
            return true;
          } catch (e) {
            console.error(e);
            const errEl = document.getElementById('clientError');
            errEl.textContent = 'Error de red';
            errEl.hidden = false;
            return false;
          }
        }

        async function addClients(days, { name, phone, notes }) {
          const errEl = document.getElementById('clientError');
          errEl.hidden = true; errEl.textContent = '';
          const ordered = Array.from(new Set(days)).sort();
          if (ordered.length === 0) {
            errEl.textContent = 'Selecciona al menos un d√≠a laborable.';
            errEl.hidden = false;
            return false;
          }

          let hadAnySuccess = false;
          for (const dayISO of ordered) {
            const ok = await addClient({ dayISO, name, phone, notes }, { skipRefresh: true });
            if (!ok) {
              if (hadAnySuccess) {
                await render();
                if (modalDayISO) await loadClientsInModal(modalDayISO);
              }
              return false;
            }
            hadAnySuccess = true;
          }

          if (hadAnySuccess) {
            await render();
            if (modalDayISO) await loadClientsInModal(modalDayISO);
          }
          return true;
        }

        let modalDayISO = null;
        let modalSelectedDays = new Set();
        let modalCalYear = null;
        let modalCalMonth = null;
        let detailContext = { id: null, day: null, name: '', phone: '', notes: '' };
        function startOfWeek(d) {
          // Retorna lunes de la semana para una fecha dada (UTC)
          const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
          const weekday = dt.getUTCDay(); // 0=Dom..6=Sab
          const diff = (weekday === 0 ? -6 : 1 - weekday); // mover a lunes
          dt.setUTCDate(dt.getUTCDate() + diff);
          return dt;
        }

        // Estado de vista
        state.view = 'month';
        state.weekAnchor = startOfWeek(new Date());
        function openModal(dayISO) {
          modalDayISO = dayISO;
          modalSelectedDays = new Set(dayISO ? [dayISO] : []);
          const baseDate = new Date(dayISO + 'T00:00:00Z');
          if (!Number.isNaN(baseDate.getTime())) {
            modalCalYear = baseDate.getUTCFullYear();
            modalCalMonth = baseDate.getUTCMonth();
          } else {
            const fallback = new Date();
            modalCalYear = fallback.getUTCFullYear();
            modalCalMonth = fallback.getUTCMonth();
          }
          if (clientDateInput) clientDateInput.value = dayISO;
          updateSelectedDaysSummary();
          renderMiniCalendar();
          document.getElementById('clientName').value = '';
          document.getElementById('clientPhone').value = '';
          document.getElementById('clientNotes').value = '';
          document.getElementById('clientError').hidden = true;
          document.getElementById('clientError').textContent = '';
          const modal = document.getElementById('clientModal');
          modal.setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
          document.getElementById('clientName').focus();
          loadClientsInModal(dayISO);
        }
        function closeModal() {
          const modal = document.getElementById('clientModal');
          modal.setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
        }

        // B√∫squeda
        function openSearch() {
          document.getElementById('searchInput').value = '';
          document.getElementById('searchError').hidden = true;
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('searchModal').setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
        }
        function closeSearch() {
          document.getElementById('searchModal').setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
        }
        async function performSearch(name) {
          const errEl = document.getElementById('searchError');
          const list = document.getElementById('searchResults');
          errEl.hidden = true; errEl.textContent = '';
          list.innerHTML = '<li class="muted">Buscando...</li>';
          try {
            const res = await fetch(`${API_BASE}/api/clients/search?name=${encodeURIComponent(name)}`);
            const data = await res.json();
            if (!res.ok || !data.ok) {
              errEl.textContent = data.error || 'Error en la b√∫squeda';
              errEl.hidden = false;
              list.innerHTML = '';
              return;
            }
            const rows = data.rows || [];
            if (rows.length === 0) {
              list.innerHTML = '<li class="muted">Sin resultados</li>';
              return;
            }
            list.innerHTML = rows.map(r => {
              const iso = r.day;
              const date = new Date(iso + 'T00:00:00Z');
              const label = `${date.getUTCDate()}/${String(date.getUTCMonth()+1).padStart(2,'0')}/${date.getUTCFullYear()}`;
              const tags = buildClientTags(r);
              const nameAttr = escapeHtml(r.name || '');
              const phoneAttr = escapeHtml(r.phone || '');
              const notesAttr = escapeHtml(r.notes || '');
              const idAttr = escapeHtml(String(r.id || ''));
              return `
                <li data-iso="${iso}" data-client-id="${idAttr}" data-client-day="${iso}" data-client-name="${nameAttr}" data-client-phone="${phoneAttr}" data-client-notes="${notesAttr}">
                  <div class="client-info">${tags}</div>
                  <small class="muted"> ‚Äî ${label}</small>
                  <button type="button" class="link" data-open-day>Ver d√≠a</button>
                </li>
              `;
            }).join('');
            attachClientDetailHandlers(list);
            // Ir al d√≠a desde resultados
            list.querySelectorAll('[data-open-day]').forEach(btn => {
              btn.addEventListener('click', () => {
                const iso = btn.closest('li').getAttribute('data-iso');
                closeSearch();
                // Cambiar vista al mes del resultado y abrir modal del d√≠a
                const d = new Date(iso + 'T00:00:00Z');
                state.year = d.getUTCFullYear();
                state.month = d.getUTCMonth();
                state.view = 'month';
                render().then(() => openModal(iso));
              });
            });
          } catch (e) {
            errEl.textContent = 'Error de red';
            errEl.hidden = false;
            list.innerHTML = '';
          }
        }

        async function loadClientsInModal(dayISO) {
          const list = document.getElementById('clientList');
          const remainingEl = document.getElementById('clientRemaining');
          list.innerHTML = '<li class="muted">Cargando...</li>';
          remainingEl.textContent = '';
          try {
            const res = await fetch(`${API_BASE}/api/clients?day=${dayISO}`);
            const data = await res.json();
            if (!res.ok || !data.ok) {
              list.innerHTML = `<li class="error">${data.error || 'Error al cargar'}</li>`;
              return;
            }
            const rows = data.rows || [];
            const remaining = Math.max(0, 10 - rows.length);
            remainingEl.textContent = `Plazas restantes: ${remaining} / 10`;
            if (rows.length === 0) {
              list.innerHTML = '<li class="muted">Sin clientes para este d√≠a</li>';
              return;
            }
            list.innerHTML = rows.map(r => {
              const nameAttr = escapeHtml(r.name || '');
              const phoneAttr = escapeHtml(r.phone || '');
              const notesAttr = escapeHtml(r.notes || '');
              const idAttr = escapeHtml(String(r.id || ''));
              return `
              <li data-id="${r.id}" data-client-id="${idAttr}" data-client-day="${dayISO}" data-client-name="${nameAttr}" data-client-phone="${phoneAttr}" data-client-notes="${notesAttr}">
                <div class="client-info">
                  <span class="client-name" data-text data-client-detail role="button" tabindex="0" aria-label="Ver detalle de ${nameAttr}">${escapeHtml(r.name)}</span>
                </div>
                <span class="client-actions" data-actions>
                  <button type="button" class="link primary" data-edit="${r.id}">Editar</button>
                  <button type="button" class="link danger" data-del="${r.id}">Eliminar</button>
                </span>
              </li>
            `;
            }).join('');

            // Delegar eventos para editar/eliminar inline
            list.querySelectorAll('[data-edit]').forEach(btn => {
              btn.addEventListener('click', () => enterEdit(btn.closest('li'), dayISO));
            });
            list.querySelectorAll('[data-del]').forEach(btn => {
              btn.addEventListener('click', () => enterDeleteConfirm(btn.closest('li'), dayISO));
            });
            attachClientDetailHandlers(list);
          } catch (e) {
            list.innerHTML = '<li class="error">Error de red</li>';
          }
        }

        async function deleteClient(id, dayISO) {
          try {
            const res = await fetch(`${API_BASE}/api/clients/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              alert(data.error || 'No se pudo eliminar');
              return;
            }
            await render();
            await loadClientsInModal(dayISO);
          } catch (e) {
            alert('Error de red');
          }
        }

        async function updateClientFields(id, payload) {
          if (id == null) return { ok: false, error: 'Cliente inv√°lido' };
          const body = {};
          if (Object.prototype.hasOwnProperty.call(payload, 'name')) body.name = payload.name;
          if (Object.prototype.hasOwnProperty.call(payload, 'phone')) body.phone = payload.phone;
          if (Object.prototype.hasOwnProperty.call(payload, 'notes')) body.notes = payload.notes;
          if (Object.keys(body).length === 0) return { ok: true };
          try {
            const res = await fetch(`${API_BASE}/api/clients/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              return { ok: false, error: data.error || 'No se pudo actualizar' };
            }
            return { ok: true };
          } catch (e) {
            console.error(e);
            return { ok: false, error: 'Error de red' };
          }
        }

        async function updateClientName(id, name, dayISO) {
          const result = await updateClientFields(id, { name });
          if (!result.ok) {
            alert(result.error || 'No se pudo actualizar');
            return;
          }
          await render();
          await loadClientsInModal(dayISO);
        }

        async function render() {
          const isFullMonth = state.view === 'month-full';
          if (state.view === 'week') {
            gridEl.setAttribute('role', 'grid');
            return renderWeek();
          }
          gridEl.setAttribute('role', isFullMonth ? 'list' : 'grid');
          const { year, month } = state;
          titleEl.textContent = monthNames[month] + ' ' + year + (isFullMonth ? ' ‚Äî vista completa' : '');

          // Calcula desde lunes (0) a domingo (6)
          const firstDay = new Date(year, month, 1);
          const startWeekday = (firstDay.getDay() + 6) % 7; // Lunes=0 ... Domingo=6
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const daysInPrevMonth = new Date(year, month, 0).getDate();

          const totalCells = 42; // 6 filas x 7 columnas
          const cells = [];

          // D√≠as del mes anterior que "rellenan" al inicio
          for (let i = startWeekday - 1; i >= 0; i--) {
            const dayNum = daysInPrevMonth - i;
            cells.push({ day: dayNum, other: true });
          }

          // D√≠as del mes actual
          for (let d = 1; d <= daysInMonth; d++) {
            cells.push({ day: d, other: false });
          }

          // D√≠as del mes siguiente para completar las 42 celdas
          while (cells.length < totalCells) {
            cells.push({ day: cells.length - (startWeekday + daysInMonth) + 1, other: true });
          }

          const today = new Date();
          const isSameDay = (y, m, d) => today.getFullYear() === y && today.getMonth() === m && today.getDate() === d;

          const summary = await fetchSummary(year, month);
          if (state.view === 'month-full') {
            const weeks = [];
            const start = startOfWeek(new Date(Date.UTC(year, month, 1)));
            const lastDay = new Date(Date.UTC(year, month + 1, 0));
            const end = startOfWeek(lastDay);
            end.setUTCDate(end.getUTCDate() + 6);
            const cursor = new Date(start);
            while (cursor <= end) {
              const buttons = [];
              for (let i = 0; i < 7; i++) {
                const current = new Date(cursor);
                const iso = `${current.getUTCFullYear()}-${String(current.getUTCMonth() + 1).padStart(2,'0')}-${String(current.getUTCDate()).padStart(2,'0')}`;
                const inThisMonth = current.getUTCMonth() === month;
                const isWeekend = current.getUTCDay() === 0 || current.getUTCDay() === 6;
                const dayInfo = summary[iso];
                let clients = [];
                if (dayInfo) {
                  if (Array.isArray(dayInfo.clients)) clients = dayInfo.clients;
                  else if (typeof dayInfo.clients === 'string') {
                    try { const parsed = JSON.parse(dayInfo.clients); if (Array.isArray(parsed)) clients = parsed; } catch (_) {}
                  }
                }
                const count = inThisMonth ? (dayInfo ? Number(dayInfo.count ?? clients.length ?? 0) : clients.length) : 0;
                const namesList = inThisMonth && clients.length
                  ? clients.map((client) => buildCalendarEntry(client, iso)).filter(Boolean).join('')
                  : '';
                const isTodayCell = inThisMonth && isSameDay(current.getUTCFullYear(), current.getUTCMonth(), current.getUTCDate());
                const classes = ['calendar__cell'];
                if (!inThisMonth) classes.push('is-other');
                if (isWeekend) classes.push('is-weekend');
                if (isTodayCell) classes.push('is-today');
                buttons.push(`
                  <button class="${classes.join(' ')}"
                          role="gridcell" aria-selected="${isTodayCell ? 'true' : 'false'}"
                          data-iso="${iso}" data-weekend="${isWeekend}" data-other="${inThisMonth ? 'false' : 'true'}" data-count="${count}">
                    <div class="calendar__dow">${['Lu','Ma','Mi','Ju','Vi','Sa','Do'][i]}</div>
                    <span class="calendar__date">${current.getUTCDate()}</span>
                    ${count > 0 ? `<span class="calendar__badge" data-count="${count}" data-see="${iso}" title="Ver ${count} cliente(s)">${count}</span>` : ''}
                    ${namesList ? `<ul class="calendar__names">${namesList}</ul>` : ''}
                  </button>
                `);
                cursor.setUTCDate(cursor.getUTCDate() + 1);
              }
              weeks.push(`<div class="calendar-week-row">${buttons.join('')}</div>`);
            }
            gridEl.innerHTML = weeks.join('');
            gridEl.querySelectorAll('.calendar-week-row .calendar__cell').forEach((btn) => {
              btn.addEventListener('click', () => {
                if (btn.getAttribute('data-other') === 'true') return;
                const iso = btn.getAttribute('data-iso');
                if (iso) openModal(iso);
              });
            });
          } else {
            gridEl.innerHTML = cells.map((c, idx) => {
              const inOtherMonth = c.other;
              const inThisMonth = !inOtherMonth;
              const dayNum = c.day;
              const isToday = inThisMonth && isSameDay(state.year, state.month, dayNum);
              const col = idx % 7;
              const isWeekend = col === 5 || col === 6;
              const dayISO = `${year}-${String(month + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
              const dayInfo = inThisMonth ? summary[dayISO] : undefined;
              const count = dayInfo ? Number(dayInfo.count) : 0;
              const entries = dayInfo && Array.isArray(dayInfo.clients)
                ? dayInfo.clients.map((client) => buildCalendarEntry(client, dayISO)).filter(Boolean).join('')
                : '';
              return `
                <button class="calendar__cell${inOtherMonth ? ' is-other' : ''}${isToday ? ' is-today' : ''}${isWeekend ? ' is-weekend' : ''}"
                        role="gridcell" aria-selected="${isToday ? 'true' : 'false'}"
                        tabindex="${idx === 0 ? '0' : '-1'}" data-day="${dayNum}" data-iso="${dayISO}" data-weekend="${isWeekend}" data-other="${inOtherMonth}" data-count="${count}">
                  <span class="calendar__date">${dayNum}</span>
                  ${inThisMonth && count > 0 ? `<span class="calendar__badge" data-count="${count}" title="Ver ${count} cliente(s)" data-see="${dayISO}">${count}</span>` : ''}
                  ${entries ? `<ul class="calendar__names">${entries}</ul>` : ''}
                </button>
              `;
            }).join('');

            gridEl.querySelectorAll('.calendar__cell').forEach((btn) => {
              btn.addEventListener('click', (e) => {
                if (e.target.closest('.calendar__badge')) return;
                if (btn.getAttribute('data-other') === 'true') return;
                const iso = btn.getAttribute('data-iso');
                const [yearVal, monthIndex, dayNumVal] = iso.split('-').map(Number);
                const targetDate = new Date(yearVal, monthIndex - 1, dayNumVal);
                setView('week', targetDate);
              });
            });
          }

          gridEl.querySelectorAll('.calendar__badge[data-see]').forEach((badge) => {
            badge.addEventListener('click', (e) => {
              e.stopPropagation();
              const iso = badge.getAttribute('data-see');
              if (iso) openModal(iso);
            });
          });
          attachClientDetailHandlers(gridEl);
        }

        async function fetchClientsForDay(dayISO) {
          try {
            const res = await fetch(`${API_BASE}/api/clients?day=${dayISO}`);
            const data = await res.json();
            if (!data.ok) return [];
            return data.rows || [];
          } catch {
            return [];
          }
        }

        async function renderWeek() {
          const monday = startOfWeek(state.weekAnchor);
          const days = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(monday);
            d.setUTCDate(monday.getUTCDate() + i);
            days.push(d);
          }
          const end = days[6];
          const title = `${monday.getUTCDate()}/${monday.getUTCMonth()+1}/${monday.getUTCFullYear()} - ${end.getUTCDate()}/${end.getUTCMonth()+1}/${end.getUTCFullYear()}`;
          titleEl.textContent = `Semana: ${title}`;

          // Obtener listas de clientes por d√≠a (7 peticiones en paralelo)
          const isos = days.map(d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`);
          const lists = await Promise.all(isos.map(iso => fetchClientsForDay(iso)));
          const dataByIso = {};
          isos.forEach((iso, i) => { dataByIso[iso] = lists[i]; });

          const dow = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
          gridEl.innerHTML = days.map((d, idx) => {
            const iso = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
            const today = new Date();
            const isToday = today.getUTCFullYear() === d.getUTCFullYear() && today.getUTCMonth() === d.getUTCMonth() && today.getUTCDate() === d.getUTCDate();
            const isWeekend = idx >= 5; // sab=5, dom=6 en esta lista
            const rows = dataByIso[iso] || [];
            const count = rows.length;
            const namesList = rows.map((r) => buildCalendarEntry(r, iso)).filter(Boolean).join('');
            return `
              <button class="calendar__cell${isToday ? ' is-today' : ''}${isWeekend ? ' is-weekend' : ''}"
                      role="gridcell" aria-selected="${isToday ? 'true' : 'false'}"
                      data-iso="${iso}" data-weekend="${isWeekend}" data-other="false" data-count="${count}">
                <div class="calendar__dow">${dow[idx]}</div>
                <span class="calendar__date">${d.getUTCDate()}</span>
                ${count > 0 ? `<span class=\"calendar__badge\" data-count=\"${count}\" title=\"Ver ${count} cliente(s)\" data-see=\"${iso}\">${count}</span>` : ''}
                ${namesList ? `<ul class=\"calendar__names\">${namesList}</ul>` : ''}
              </button>
            `;
          }).join('');

          gridEl.querySelectorAll('.calendar__cell').forEach((btn) => {
            btn.addEventListener('click', () => {
              const isWeekendAttr = btn.getAttribute('data-weekend') === 'true';
              if (isWeekendAttr) return;
              const iso = btn.getAttribute('data-iso');
              openModal(iso);
            });
          });
          // Click en el badge: abre el modal del d√≠a (vista semanal)
          gridEl.querySelectorAll('.calendar__badge[data-see]').forEach((badge) => {
            badge.addEventListener('click', (e) => {
              e.stopPropagation();
              const iso = badge.getAttribute('data-see');
              openModal(iso);
            });
          });
          attachClientDetailHandlers(gridEl);
        }

        function addMonth(delta) {
          const d = new Date(state.year, state.month + delta, 1);
          state.year = d.getFullYear();
          state.month = d.getMonth();
          render();
        }
        function addWeek(delta) {
          const d = new Date(state.weekAnchor);
          d.setDate(d.getDate() + (delta * 7));
          state.weekAnchor = d;
          render();
        }

        // Navegaci√≥n seg√∫n vista
        prevBtn.addEventListener('click', () => {
          if (state.view === 'week') addWeek(-1);
          else addMonth(-1);
        });
        nextBtn.addEventListener('click', () => {
          if (state.view === 'week') addWeek(1);
          else addMonth(1);
        });
        if (miniCalPrevBtn) miniCalPrevBtn.addEventListener('click', () => shiftMiniCalMonth(-1));
        if (miniCalNextBtn) miniCalNextBtn.addEventListener('click', () => shiftMiniCalMonth(1));

        // Toggle de vista
        function setView(view, date = null) {
          if (state.view === view && !date) return; // Ya est√° en esta vista
          
          state.view = view;
          viewMonthBtn.classList.toggle('is-active', view === 'month');
          viewWeekBtn.classList.toggle('is-active', view === 'week');
          if (viewMonthFullBtn) viewMonthFullBtn.classList.toggle('is-active', view === 'month-full');
          if (calendarContainer) {
            calendarContainer.classList.toggle('is-week', view === 'week');
            calendarContainer.classList.toggle('is-month-full', view === 'month-full');
          }
          viewMonthBtn.setAttribute('aria-selected', view === 'month' ? 'true' : 'false');
          viewWeekBtn.setAttribute('aria-selected', view === 'week' ? 'true' : 'false');
          if (viewMonthFullBtn) viewMonthFullBtn.setAttribute('aria-selected', view === 'month-full' ? 'true' : 'false');

          // Si cambiamos a vista semanal y se proporciona una fecha, centrar en esa semana
          if (view === 'week' && date) {
            state.weekAnchor = new Date(date);
          } 
          // Si cambiamos a vista semanal sin fecha, usar la semana actual
          else if (view === 'week' && !state.weekAnchor) {
            state.weekAnchor = new Date();
          }

          render();
        }
        
        viewMonthBtn.addEventListener('click', () => setView('month'));
        viewWeekBtn.addEventListener('click', () => setView('week'));
        if (viewMonthFullBtn) viewMonthFullBtn.addEventListener('click', () => setView('month-full'));

        // Cerrar modal
        document.querySelectorAll('[data-close-modal]').forEach(el => {
          el.addEventListener('click', closeModal);
        });
        document.querySelectorAll('[data-close-detail]').forEach(el => {
          el.addEventListener('click', closeClientDetail);
        });
        if (detailResetBtn) {
          detailResetBtn.addEventListener('click', () => {
            setDetailFormValues(detailContext);
            clearDetailMessage();
            if (detailNameInput) detailNameInput.focus();
          });
        }
        if (detailForm) {
          detailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!detailContext || detailContext.id == null) {
              showDetailMessage('No se pudo identificar al cliente.');
              return;
            }
            const name = detailNameInput ? detailNameInput.value.trim() : '';
            if (!name) {
              showDetailMessage('El nombre es obligatorio.');
              if (detailNameInput) detailNameInput.focus();
              return;
            }
            const phone = detailPhoneInput ? detailPhoneInput.value.trim() : '';
            const notes = detailNotesInput ? detailNotesInput.value.trim() : '';

            const payload = {};
            if (name !== detailContext.name) payload.name = name;
            if (phone !== detailContext.phone) payload.phone = phone.length ? phone : null;
            if (notes !== detailContext.notes) payload.notes = notes.length ? notes : null;

            if (Object.keys(payload).length === 0) {
              showDetailMessage('No hay cambios que guardar.', true);
              return;
            }

            const result = await updateClientFields(detailContext.id, payload);
            if (!result.ok) {
              showDetailMessage(result.error || 'No se pudo actualizar');
              return;
            }

            detailContext = {
              id: detailContext.id,
              day: detailContext.day,
              name,
              phone,
              notes
            };
            setDetailFormValues(detailContext);
            showDetailMessage('Cambios guardados correctamente.', true);
            await render();
            if (detailContext.day) await loadClientsInModal(detailContext.day);
          });
        }
        if (detailDeleteBtn) {
          detailDeleteBtn.addEventListener('click', async () => {
            if (!detailContext || detailContext.id == null) {
              showDetailMessage('No se pudo identificar al cliente.');
              return;
            }
            const confirmDelete = window.confirm('¬øEliminar este cliente? Esta acci√≥n no se puede deshacer.');
            if (!confirmDelete) return;
            const dayISO = detailContext.day;
            await deleteClient(detailContext.id, dayISO);
            showDetailMessage('Cliente eliminado.', true);
            closeClientDetail();
          });
        }
        // B√∫squeda: abrir/cerrar y submit
        searchBtn.addEventListener('click', openSearch);
        document.querySelectorAll('[data-close-search]').forEach(el => el.addEventListener('click', closeSearch));
        document.getElementById('searchForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const q = document.getElementById('searchInput').value.trim();
          if (!q) return;
          performSearch(q);
        });
        // Enviar formulario de modal
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const nameInput = document.getElementById('clientName');
          const phoneInput = document.getElementById('clientPhone');
          const notesInput = document.getElementById('clientNotes');

          const name = nameInput.value.trim();
          if (!name) return;

          const phone = phoneInput.value.trim();
          const notes = notesInput.value.trim();

          const selectedDays = Array.from(modalSelectedDays);
          const ok = await addClients(selectedDays, {
            name,
            phone: phone.length ? phone : null,
            notes: notes.length ? notes : null
          });

          if (ok) {
            nameInput.value = '';
            phoneInput.value = '';
            notesInput.value = '';
            nameInput.focus();
            modalSelectedDays = new Set(modalDayISO ? [modalDayISO] : []);
            if (modalDayISO) {
              const base = new Date(modalDayISO + 'T00:00:00Z');
              if (!Number.isNaN(base.getTime())) {
                modalCalYear = base.getUTCFullYear();
                modalCalMonth = base.getUTCMonth();
              }
            }
            updateSelectedDaysSummary();
            renderMiniCalendar();
          }
        });

        render();
      })();

      // Inserta el a√±o actual autom√°ticamente en el footer
      document.getElementById('year').textContent = new Date().getFullYear();
    </script>
  </body>
</html>
