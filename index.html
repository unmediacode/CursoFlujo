<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>P√°gina Sencilla</title>
    <meta name="description" content="Una p√°gina muy sencilla hecha con HTML y CSS." />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <h1 class="logo">Mi P√°gina</h1>
        <nav class="nav">
          <a href="#inicio">Inicio</a>
        </nav>
      </div>
    </header>

    <main id="inicio">
      <section class="container">
        <div class="calendar" aria-label="Calendario mensual">
          <div class="calendar__header">
            <div class="left-actions">
              <button class="cal-btn" id="prevBtn" aria-label="Anterior">‚Äπ</button>
            </div>
            <h2 class="calendar__title" id="calTitle" aria-live="polite"></h2>
            <div class="right-actions">
              <button class="cal-btn" id="searchBtn" aria-label="Buscar clientes">üîé</button>
              <button class="cal-btn" id="nextBtn" aria-label="Siguiente">‚Ä∫</button>
            </div>
          </div>
          <div class="view-toggle" role="tablist" aria-label="Selector de vista">
            <button id="viewMonth" class="view-toggle__btn is-active" role="tab" aria-selected="true">Mensual</button>
            <button id="viewWeek" class="view-toggle__btn" role="tab" aria-selected="false">Semanal</button>
          </div>

          <div class="calendar__weekdays" aria-hidden="true">
            <span>Lu</span>
            <span>Ma</span>
            <span>Mi</span>
            <span>Ju</span>
            <span>Vi</span>
            <span>Sa</span>
            <span>Do</span>
          </div>

          <div class="calendar__grid" id="calGrid" role="grid" aria-readonly="true" aria-label="D√≠as del mes"></div>
        </div>
      </section>
      
      <!-- Modal para a√±adir cliente -->
      <div class="modal" id="clientModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal__overlay" data-close-modal></div>
        <div class="modal__content" role="document">
          <h3 id="modalTitle">A√±adir cliente</h3>
          <form id="clientForm">
            <div class="form-row">
              <label>Fecha</label>
              <input type="text" id="clientDate" readonly />
            </div>
            <div class="form-row">
              <label>Nombre del cliente</label>
              <input type="text" id="clientName" placeholder="Ej. Juan P√©rez" required />
            </div>
            <div class="form-row">
              <label>Tel√©fono</label>
              <input type="tel" id="clientPhone" placeholder="Ej. 600 123 123" />
            </div>
            <div class="form-row">
              <label>Notas</label>
              <textarea id="clientNotes" rows="2" placeholder="Observaciones (opcional)"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">A√±adir cliente</button>
              <button type="button" class="btn btn--secondary" data-close-modal>Cancelar</button>
            </div>
            <p class="form-error" id="clientError" hidden></p>
            <div class="client-meta">
              <small id="clientRemaining"></small>
            </div>
            <ul id="clientList" class="client-list" aria-live="polite"></ul>
          </form>
        </div>
      </div>

      <!-- Modal de detalle de cliente -->
      <div class="modal" id="clientDetailModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
        <div class="modal__overlay" data-close-detail></div>
        <div class="modal__content client-detail" role="document">
          <h3 id="detailTitle">Detalle del cliente</h3>
          <dl class="client-detail__list">
            <div>
              <dt>Nombre</dt>
              <dd id="detailName">‚Äî</dd>
            </div>
            <div>
              <dt>Tel√©fono</dt>
              <dd id="detailPhone">‚Äî</dd>
            </div>
            <div>
              <dt>Notas</dt>
              <dd id="detailNotes">‚Äî</dd>
            </div>
          </dl>
          <div class="form-actions client-detail__actions">
            <button type="button" class="btn btn--secondary" data-close-detail>Cerrar</button>
          </div>
        </div>
      </div>

      <!-- Modal de b√∫squeda -->
      <div class="modal" id="searchModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
        <div class="modal__overlay" data-close-search></div>
        <div class="modal__content" role="document">
          <h3 id="searchTitle">Buscar clientes por nombre</h3>
          <form id="searchForm">
            <div class="form-row">
              <label>Nombre contiene</label>
              <input type="text" id="searchInput" placeholder="Ej. Juan" required />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Buscar</button>
              <button type="button" class="btn btn--secondary" data-close-search>Cancelar</button>
            </div>
            <p class="form-error" id="searchError" hidden></p>
          </form>
          <ul id="searchResults" class="client-list" aria-live="polite"></ul>
        </div>
      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <small>¬© 2025 ‚Äî Hecha por su hermano, Miguel Taboada, con amor ‚ù§Ô∏è</small>
      </div>
    </footer>

    <script>
      // L√≥gica del calendario mensual con paginaci√≥n (prev/next)
      (function() {
        const monthNames = [
          'Enero','Febrero','Marzo','Abril','Mayo','Junio',
          'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'
        ];

        const state = (function initState() {
          const now = new Date();
          return { year: now.getFullYear(), month: now.getMonth() };
        })();

        const titleEl = document.getElementById('calTitle');
        const gridEl = document.getElementById('calGrid');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const viewMonthBtn = document.getElementById('viewMonth');
        const viewWeekBtn = document.getElementById('viewWeek');
        const searchBtn = document.getElementById('searchBtn');
        const detailModal = document.getElementById('clientDetailModal');
        const detailNameEl = document.getElementById('detailName');
        const detailPhoneEl = document.getElementById('detailPhone');
        const detailNotesEl = document.getElementById('detailNotes');

        const API_BASE = 'http://localhost:3000';

        function escapeHtml(str) {
          return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
        }

        function buildClientTags(client) {
          if (!client) return '';
          const name = typeof client.name === 'string' ? client.name.trim() : '';
          const phone = typeof client.phone === 'string' ? client.phone.trim() : '';
          const notes = typeof client.notes === 'string' ? client.notes.trim() : '';
          const attrs = `data-client-detail="true" data-client-name="${escapeHtml(name)}" data-client-phone="${escapeHtml(phone)}" data-client-notes="${escapeHtml(notes)}" role="button" tabindex="0"`;
          const parts = [];
          if (name) parts.push(`<span class="calendar__tag calendar__tag--name" ${attrs} aria-label="Ver detalle de ${escapeHtml(name)}">${escapeHtml(name)}</span>`);
          if (phone) parts.push(`<span class="calendar__tag calendar__tag--phone">${escapeHtml(phone)}</span>`);
          if (notes) parts.push(`<span class="calendar__tag calendar__tag--notes">${escapeHtml(notes)}</span>`);
          return parts.join('');
        }

        function buildCalendarEntry(client) {
          const content = buildClientTags(client);
          return content ? `<li class="calendar__entry">${content}</li>` : '';
        }

        function syncBodyScrollLock() {
          const anyOpen = Array.from(document.querySelectorAll('.modal')).some(modal => modal.getAttribute('aria-hidden') === 'false');
          document.body.style.overflow = anyOpen ? 'hidden' : '';
        }

        function openClientDetail({ name, phone, notes }) {
          detailNameEl.textContent = name || '‚Äî';
          detailPhoneEl.textContent = phone || '‚Äî';
          detailNotesEl.textContent = notes || '‚Äî';
          detailModal.setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
        }

        function closeClientDetail() {
          detailModal.setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
        }

        function attachClientDetailHandlers(root = document) {
          if (!root) return;
          root.querySelectorAll('[data-client-detail]').forEach(el => {
            if (el.dataset.clientDetailBound === '1') return;
            el.dataset.clientDetailBound = '1';
            el.addEventListener('click', (ev) => {
              ev.stopPropagation();
              openClientDetail({
                name: el.getAttribute('data-client-name') || '',
                phone: el.getAttribute('data-client-phone') || '',
                notes: el.getAttribute('data-client-notes') || ''
              });
            });
            el.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter' || ev.key === ' ') {
                ev.preventDefault();
                openClientDetail({
                  name: el.getAttribute('data-client-name') || '',
                  phone: el.getAttribute('data-client-phone') || '',
                  notes: el.getAttribute('data-client-notes') || ''
                });
              }
            });
          });
        }

        // UI helpers: edici√≥n inline
        function enterEdit(li, dayISO) {
          const id = li.getAttribute('data-id');
          const nameEl = li.querySelector('[data-text]');
          const actions = li.querySelector('[data-actions]');
          const current = nameEl.textContent.trim();
          li.classList.add('is-editing');
          nameEl.innerHTML = `<input type="text" class="inline-input" value="${escapeHtml(current)}" />`;
          actions.innerHTML = `
            <button type="button" class="link primary" data-save>Guardar</button>
            <button type="button" class="link" data-cancel>Cancelar</button>
          `;
          actions.querySelector('[data-save]').addEventListener('click', async () => {
            const val = li.querySelector('.inline-input').value.trim();
            if (!val || val === current) { exitEdit(li, current); return; }
            await updateClientName(id, val, dayISO);
          });
          actions.querySelector('[data-cancel]').addEventListener('click', () => exitEdit(li, current));
        }

        function exitEdit(li, text) {
          const nameEl = li.querySelector('[data-text]');
          const actions = li.querySelector('[data-actions]');
          nameEl.textContent = text;
          actions.innerHTML = `
            <button type="button" class="link primary" data-edit="${li.getAttribute('data-id')}">Editar</button>
            <button type="button" class="link danger" data-del="${li.getAttribute('data-id')}">Eliminar</button>
          `;
          li.classList.remove('is-editing');
          // Reenganchar eventos
          actions.querySelector('[data-edit]').addEventListener('click', () => enterEdit(li, document.getElementById('clientDate').value));
          actions.querySelector('[data-del]').addEventListener('click', () => enterDeleteConfirm(li, document.getElementById('clientDate').value));
        }

        // UI helpers: confirmaci√≥n de borrado inline
        function enterDeleteConfirm(li, dayISO) {
          const id = li.getAttribute('data-id');
          const actions = li.querySelector('[data-actions]');
          const prev = actions.innerHTML;
          actions.setAttribute('data-prev', prev);
          actions.innerHTML = `
            <span class="confirm-text">¬øEliminar?</span>
            <button type="button" class="link danger" data-confirm>Confirmar</button>
            <button type="button" class="link" data-cancel>Cancelar</button>
          `;
          actions.querySelector('[data-confirm]').addEventListener('click', async () => {
            await deleteClient(id, dayISO);
          });
          actions.querySelector('[data-cancel]').addEventListener('click', () => {
            actions.innerHTML = actions.getAttribute('data-prev');
            actions.removeAttribute('data-prev');
            // Reenganchar eventos
            actions.querySelector('[data-edit]').addEventListener('click', () => enterEdit(li, dayISO));
            actions.querySelector('[data-del]').addEventListener('click', () => enterDeleteConfirm(li, dayISO));
          });
        }

        async function fetchSummary(year, month /* 0-11 */) {
          const y = year;
          const m = month + 1; // API espera 1..12
          try {
            const res = await fetch(`${API_BASE}/api/clients/summary?year=${y}&month=${m}`);
            const data = await res.json();
            if (!data.ok) return {};
            // Mapa YYYY-MM-DD -> { count, clients: [] }
            const map = {};
            for (const r of data.rows || []) {
              let clients = [];
              if (Array.isArray(r.clients)) {
                clients = r.clients;
              } else if (typeof r.clients === 'string') {
                try {
                  clients = JSON.parse(r.clients) || [];
                } catch (_) {
                  clients = [];
                }
              }
              map[r.day] = {
                count: Number(r.count ?? clients.length ?? 0),
                clients
              };
            }
            return map;
          } catch (e) {
            console.error('summary error', e);
            return {};
          }
        }

        async function addClient({ dayISO, name, phone, notes }) {
          const errEl = document.getElementById('clientError');
          errEl.hidden = true; errEl.textContent = '';
          try {
            const res = await fetch(`${API_BASE}/api/clients`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ day: dayISO, name, phone, notes })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              errEl.textContent = data.error || 'Error al a√±adir cliente';
              errEl.hidden = false;
              return false;
            }
            await render();
            await loadClientsInModal(dayISO);
            return true;
          } catch (e) {
            console.error(e);
            const errEl = document.getElementById('clientError');
            errEl.textContent = 'Error de red';
            errEl.hidden = false;
            return false;
          }
        }

        let modalDayISO = null;
        function startOfWeek(d) {
          // Retorna lunes de la semana para una fecha dada (UTC)
          const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
          const weekday = dt.getUTCDay(); // 0=Dom..6=Sab
          const diff = (weekday === 0 ? -6 : 1 - weekday); // mover a lunes
          dt.setUTCDate(dt.getUTCDate() + diff);
          return dt;
        }

        // Estado de vista
        state.view = 'month';
        state.weekAnchor = startOfWeek(new Date());
        function openModal(dayISO) {
          modalDayISO = dayISO;
          document.getElementById('clientDate').value = dayISO;
          document.getElementById('clientName').value = '';
          document.getElementById('clientPhone').value = '';
          document.getElementById('clientNotes').value = '';
          document.getElementById('clientError').hidden = true;
          document.getElementById('clientError').textContent = '';
          const modal = document.getElementById('clientModal');
          modal.setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
          document.getElementById('clientName').focus();
          loadClientsInModal(dayISO);
        }
        function closeModal() {
          const modal = document.getElementById('clientModal');
          modal.setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
        }

        // B√∫squeda
        function openSearch() {
          document.getElementById('searchInput').value = '';
          document.getElementById('searchError').hidden = true;
          document.getElementById('searchResults').innerHTML = '';
          document.getElementById('searchModal').setAttribute('aria-hidden', 'false');
          syncBodyScrollLock();
        }
        function closeSearch() {
          document.getElementById('searchModal').setAttribute('aria-hidden', 'true');
          syncBodyScrollLock();
        }
        async function performSearch(name) {
          const errEl = document.getElementById('searchError');
          const list = document.getElementById('searchResults');
          errEl.hidden = true; errEl.textContent = '';
          list.innerHTML = '<li class="muted">Buscando...</li>';
          try {
            const res = await fetch(`${API_BASE}/api/clients/search?name=${encodeURIComponent(name)}`);
            const data = await res.json();
            if (!res.ok || !data.ok) {
              errEl.textContent = data.error || 'Error en la b√∫squeda';
              errEl.hidden = false;
              list.innerHTML = '';
              return;
            }
            const rows = data.rows || [];
            if (rows.length === 0) {
              list.innerHTML = '<li class="muted">Sin resultados</li>';
              return;
            }
            list.innerHTML = rows.map(r => {
              const iso = r.day;
              const date = new Date(iso + 'T00:00:00Z');
              const label = `${date.getUTCDate()}/${String(date.getUTCMonth()+1).padStart(2,'0')}/${date.getUTCFullYear()}`;
              const tags = buildClientTags(r);
              return `
                <li data-iso="${iso}">
                  <div class="client-info">${tags}</div>
                  <small class="muted"> ‚Äî ${label}</small>
                  <button type="button" class="link" data-open-day>Ver d√≠a</button>
                </li>
              `;
            }).join('');
            attachClientDetailHandlers(list);
            // Ir al d√≠a desde resultados
            list.querySelectorAll('[data-open-day]').forEach(btn => {
              btn.addEventListener('click', () => {
                const iso = btn.closest('li').getAttribute('data-iso');
                closeSearch();
                // Cambiar vista al mes del resultado y abrir modal del d√≠a
                const d = new Date(iso + 'T00:00:00Z');
                state.year = d.getUTCFullYear();
                state.month = d.getUTCMonth();
                state.view = 'month';
                render().then(() => openModal(iso));
              });
            });
          } catch (e) {
            errEl.textContent = 'Error de red';
            errEl.hidden = false;
            list.innerHTML = '';
          }
        }

        async function loadClientsInModal(dayISO) {
          const list = document.getElementById('clientList');
          const remainingEl = document.getElementById('clientRemaining');
          list.innerHTML = '<li class="muted">Cargando...</li>';
          remainingEl.textContent = '';
          try {
            const res = await fetch(`${API_BASE}/api/clients?day=${dayISO}`);
            const data = await res.json();
            if (!res.ok || !data.ok) {
              list.innerHTML = `<li class="error">${data.error || 'Error al cargar'}</li>`;
              return;
            }
            const rows = data.rows || [];
            const remaining = Math.max(0, 10 - rows.length);
            remainingEl.textContent = `Plazas restantes: ${remaining} / 10`;
            if (rows.length === 0) {
              list.innerHTML = '<li class="muted">Sin clientes para este d√≠a</li>';
              return;
            }
            list.innerHTML = rows.map(r => `
              <li data-id="${r.id}">
                <div class="client-info">
                  <span class="client-name" data-text>${escapeHtml(r.name)}</span>
                  ${r.phone ? `<span class="client-phone calendar__tag calendar__tag--phone">${escapeHtml(r.phone)}</span>` : ''}
                  ${r.notes ? `<span class="client-notes calendar__tag calendar__tag--notes">${escapeHtml(r.notes)}</span>` : ''}
                </div>
                <span class="client-actions" data-actions>
                  <button type="button" class="link primary" data-edit="${r.id}">Editar</button>
                  <button type="button" class="link danger" data-del="${r.id}">Eliminar</button>
                </span>
              </li>
            `).join('');

            // Delegar eventos para editar/eliminar inline
            list.querySelectorAll('[data-edit]').forEach(btn => {
              btn.addEventListener('click', () => enterEdit(btn.closest('li'), dayISO));
            });
            list.querySelectorAll('[data-del]').forEach(btn => {
              btn.addEventListener('click', () => enterDeleteConfirm(btn.closest('li'), dayISO));
            });
          } catch (e) {
            list.innerHTML = '<li class="error">Error de red</li>';
          }
        }

        async function deleteClient(id, dayISO) {
          try {
            const res = await fetch(`${API_BASE}/api/clients/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              alert(data.error || 'No se pudo eliminar');
              return;
            }
            await render();
            await loadClientsInModal(dayISO);
          } catch (e) {
            alert('Error de red');
          }
        }

        async function updateClientName(id, name, dayISO) {
          try {
            const res = await fetch(`${API_BASE}/api/clients/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              alert(data.error || 'No se pudo actualizar');
              return;
            }
            await render();
            await loadClientsInModal(dayISO);
          } catch (e) {
            alert('Error de red');
          }
        }

        async function render() {
          if (state.view === 'week') {
            return renderWeek();
          }
          const { year, month } = state;
          titleEl.textContent = monthNames[month] + ' ' + year;

          // Calcula desde lunes (0) a domingo (6)
          const firstDay = new Date(year, month, 1);
          const startWeekday = (firstDay.getDay() + 6) % 7; // Lunes=0 ... Domingo=6
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const daysInPrevMonth = new Date(year, month, 0).getDate();

          const totalCells = 42; // 6 filas x 7 columnas
          const cells = [];

          // D√≠as del mes anterior que "rellenan" al inicio
          for (let i = startWeekday - 1; i >= 0; i--) {
            const dayNum = daysInPrevMonth - i;
            cells.push({ day: dayNum, other: true });
          }

          // D√≠as del mes actual
          for (let d = 1; d <= daysInMonth; d++) {
            cells.push({ day: d, other: false });
          }

          // D√≠as del mes siguiente para completar las 42 celdas
          while (cells.length < totalCells) {
            cells.push({ day: cells.length - (startWeekday + daysInMonth) + 1, other: true });
          }

          const today = new Date();
          const isSameDay = (y, m, d) => today.getFullYear() === y && today.getMonth() === m && today.getDate() === d;

          const summary = await fetchSummary(year, month);
          gridEl.innerHTML = cells.map((c, idx) => {
            const inOtherMonth = c.other;
            const inThisMonth = !inOtherMonth;
            const dayNum = c.day;
            const isToday = inThisMonth && isSameDay(state.year, state.month, dayNum);
            const col = idx % 7; // 0=Lu, 5=Sa, 6=Do
            const isWeekend = col === 5 || col === 6;
            // Fecha ISO del d√≠a para conteo
            const dayISO = `${year}-${String(month + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
            const dayInfo = inThisMonth ? summary[dayISO] : undefined;
            const count = dayInfo ? Number(dayInfo.count) : 0;
            const entries = dayInfo && Array.isArray(dayInfo.clients)
              ? dayInfo.clients.map(buildCalendarEntry).filter(Boolean).join('')
              : '';
            return `
              <button class="calendar__cell${inOtherMonth ? ' is-other' : ''}${isToday ? ' is-today' : ''}${isWeekend ? ' is-weekend' : ''}"
                      role="gridcell" aria-selected="${isToday ? 'true' : 'false'}"
                      tabindex="${idx === 0 ? '0' : '-1'}" data-day="${dayNum}" data-iso="${dayISO}" data-weekend="${isWeekend}" data-other="${inOtherMonth}">
                <span class="calendar__date">${dayNum}</span>
                ${inThisMonth && count > 0 ? `<span class="calendar__badge" title="Ver ${count} cliente(s)" data-see="${dayISO}">${count}</span>` : ''}
                ${entries ? `<ul class="calendar__names">${entries}</ul>` : ''}
              </button>
            `;
          }).join('');

          // Click en celda: cambia a vista semanal centrada en esa fecha
          gridEl.querySelectorAll('.calendar__cell').forEach((btn) => {
            btn.addEventListener('click', (e) => {
              // Si el clic fue en el badge, manejarlo aparte (ya que tiene su propio manejador)
              if (e.target.closest('.calendar__badge')) return;

              if (btn.getAttribute('data-other') === 'true') return; // Ignorar celdas de otros meses

              const iso = btn.getAttribute('data-iso');
              const [year, monthIndex, day] = iso.split('-').map(Number);
              const targetDate = new Date(year, monthIndex - 1, day);

              setView('week', targetDate);
            });
          });
          // Click en el badge: abre el modal del d√≠a (incluso fines de semana)
          gridEl.querySelectorAll('.calendar__badge[data-see]').forEach((badge) => {
            badge.addEventListener('click', (e) => {
              e.stopPropagation();
              const iso = badge.getAttribute('data-see');
              openModal(iso);
            });
          });
          attachClientDetailHandlers(gridEl);
        }

        async function fetchClientsForDay(dayISO) {
          try {
            const res = await fetch(`${API_BASE}/api/clients?day=${dayISO}`);
            const data = await res.json();
            if (!data.ok) return [];
            return data.rows || [];
          } catch {
            return [];
          }
        }

        async function renderWeek() {
          const monday = startOfWeek(state.weekAnchor);
          const days = [];
          for (let i = 0; i < 7; i++) {
            const d = new Date(monday);
            d.setUTCDate(monday.getUTCDate() + i);
            days.push(d);
          }
          const end = days[6];
          const title = `${monday.getUTCDate()}/${monday.getUTCMonth()+1}/${monday.getUTCFullYear()} - ${end.getUTCDate()}/${end.getUTCMonth()+1}/${end.getUTCFullYear()}`;
          titleEl.textContent = `Semana: ${title}`;

          // Obtener listas de clientes por d√≠a (7 peticiones en paralelo)
          const isos = days.map(d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`);
          const lists = await Promise.all(isos.map(iso => fetchClientsForDay(iso)));
          const dataByIso = {};
          isos.forEach((iso, i) => { dataByIso[iso] = lists[i]; });

          const dow = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
          gridEl.innerHTML = days.map((d, idx) => {
            const iso = `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
            const today = new Date();
            const isToday = today.getUTCFullYear() === d.getUTCFullYear() && today.getUTCMonth() === d.getUTCMonth() && today.getUTCDate() === d.getUTCDate();
            const isWeekend = idx >= 5; // sab=5, dom=6 en esta lista
            const rows = dataByIso[iso] || [];
            const count = rows.length;
            const namesList = rows.map(buildCalendarEntry).filter(Boolean).join('');
            return `
              <button class="calendar__cell${isToday ? ' is-today' : ''}${isWeekend ? ' is-weekend' : ''}"
                      role="gridcell" aria-selected="${isToday ? 'true' : 'false'}"
                      data-iso="${iso}" data-weekend="${isWeekend}" data-other="false">
                <div class="calendar__dow">${dow[idx]}</div>
                <span class="calendar__date">${d.getUTCDate()}</span>
                ${count > 0 ? `<span class=\"calendar__badge\" title=\"Ver ${count} cliente(s)\" data-see=\"${iso}\">${count}</span>` : ''}
                ${namesList ? `<ul class=\"calendar__names\">${namesList}</ul>` : ''}
              </button>
            `;
          }).join('');

          gridEl.querySelectorAll('.calendar__cell').forEach((btn) => {
            btn.addEventListener('click', () => {
              const isWeekendAttr = btn.getAttribute('data-weekend') === 'true';
              if (isWeekendAttr) return;
              const iso = btn.getAttribute('data-iso');
              openModal(iso);
            });
          });
          // Click en el badge: abre el modal del d√≠a (vista semanal)
          gridEl.querySelectorAll('.calendar__badge[data-see]').forEach((badge) => {
            badge.addEventListener('click', (e) => {
              e.stopPropagation();
              const iso = badge.getAttribute('data-see');
              openModal(iso);
            });
          });
          attachClientDetailHandlers(gridEl);
        }

        function addMonth(delta) {
          const d = new Date(state.year, state.month + delta, 1);
          state.year = d.getFullYear();
          state.month = d.getMonth();
          render();
        }
        function addWeek(delta) {
          const d = new Date(state.weekAnchor);
          d.setDate(d.getDate() + (delta * 7));
          state.weekAnchor = d;
          render();
        }

        // Navegaci√≥n seg√∫n vista
        prevBtn.addEventListener('click', () => state.view === 'month' ? addMonth(-1) : addWeek(-1));
        nextBtn.addEventListener('click', () => state.view === 'month' ? addMonth(1) : addWeek(1));

        // Toggle de vista
        function setView(view, date = null) {
          if (state.view === view && !date) return; // Ya est√° en esta vista
          
          state.view = view;
          viewMonthBtn.classList.toggle('is-active', view === 'month');
          viewWeekBtn.classList.toggle('is-active', view === 'week');
          viewMonthBtn.setAttribute('aria-selected', view === 'month' ? 'true' : 'false');
          viewWeekBtn.setAttribute('aria-selected', view === 'week' ? 'true' : 'false');
          
          // Si cambiamos a vista semanal y se proporciona una fecha, centrar en esa semana
          if (view === 'week' && date) {
            state.weekAnchor = new Date(date);
          } 
          // Si cambiamos a vista semanal sin fecha, usar la semana actual
          else if (view === 'week' && !state.weekAnchor) {
            state.weekAnchor = new Date();
          }
          
          render();
        }
        
        viewMonthBtn.addEventListener('click', () => setView('month'));
        viewWeekBtn.addEventListener('click', () => setView('week'));

        // Cerrar modal
        document.querySelectorAll('[data-close-modal]').forEach(el => {
          el.addEventListener('click', closeModal);
        });
        document.querySelectorAll('[data-close-detail]').forEach(el => {
          el.addEventListener('click', closeClientDetail);
        });
        // B√∫squeda: abrir/cerrar y submit
        searchBtn.addEventListener('click', openSearch);
        document.querySelectorAll('[data-close-search]').forEach(el => el.addEventListener('click', closeSearch));
        document.getElementById('searchForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const q = document.getElementById('searchInput').value.trim();
          if (!q) return;
          performSearch(q);
        });
        // Enviar formulario de modal
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const nameInput = document.getElementById('clientName');
          const phoneInput = document.getElementById('clientPhone');
          const notesInput = document.getElementById('clientNotes');

          const name = nameInput.value.trim();
          if (!name) return;

          const phone = phoneInput.value.trim();
          const notes = notesInput.value.trim();

          const ok = await addClient({
            dayISO: modalDayISO,
            name,
            phone: phone.length ? phone : null,
            notes: notes.length ? notes : null
          });

          if (ok) {
            nameInput.value = '';
            phoneInput.value = '';
            notesInput.value = '';
            nameInput.focus();
          }
        });

        render();
      })();

      // Inserta el a√±o actual autom√°ticamente en el footer
      document.getElementById('year').textContent = new Date().getFullYear();
    </script>
  </body>
</html>
